
<!-- Oracle-SERVER - CONFIG ----------------------------------------------------->

<script type="text/x-red" data-template-name="oracle-server">
    <div class="form-row">
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-config-oracle-server-tabs"></ul>
    </div>
    <div id="node-config-oracle-server-tabs-content" style="min-height: 170px;">
        <div id="oracle-server-tab-connection" style="display:none">
            <div class="form-row">
                <label for="node-config-input-connectionname" style="width: 150px;"><i class="fa fa-cloud"></i> Connection Name</label>
                <input class="input-append-left" type="text" required="required" id="node-config-input-connectionname" placeholder="Name">
            </div>
            <div class="form-row">
                <label for="node-config-input-connectiontype" style="width: 150px;"><i class="fa fa-question"></i> Connection Type</label>
                <select class="input-append-left" id="node-config-input-connectiontype">
                    <option value="Classic">Classic</option>
                    <option value="TNS Name">TNS Name</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-config-input-instantclientpath" style="width: 150px;"><i class="fa fa-folder"></i> Instant Client Path</label>
                <input class="input-append-left" type="text" id="node-config-input-instantclientpath" placeholder="/path/to/instantclient">
            </div>
            <div id="wallet-container" class="connection-type">
                <div class="form-row">
                    <label for="node-config-input-tnsname" style="width: 150px;"><i class="fa fa-pencil"></i> TNS Name</label>
                    <input class="input-append-left" type="text" id="node-config-input-tnsname" placeholder="tns_name">
                </div>
            </div>
            <div id="classic-container" class="connection-type">
                <div class="form-row">
                    <label for="node-config-input-host" style="width: 150px;"><i class="fa fa-globe"></i> Server</label>
                    <input class="input-append-left" type="text" id="node-config-input-host" placeholder="localhost" style="width: 40%">
                    <label for="node-config-input-port" style="margin-left: 10px; width: 35px;"> Port</label>
                    <input type="text" id="node-config-input-port" placeholder="1521" style="width:45px">
                </div>
                <div class="form-row">
                    <label for="node-config-input-vhost" style="width: 150px;"><i class="fa fa-home"></i> Database</label>
                    <input type="text" id="node-config-input-db" placeholder="Database name">
                </div>
            </div>
            <div class="form-row">
                <input type="checkbox" id="node-config-input-reconnect" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-config-input-reconnect" style="width: 70%;"> Enable automatic connection</label>
            </div>
            <div class="form-row">
                <label for="node-config-input-reconnecttimeout" style="width: auto"><i class="fa fa-clock-o"></i> Reconnect interval (ms)</label>
                <input type="text" id="node-config-input-reconnecttimeout" style="width:60px">
            </div>
        </div>
        <div id="oracle-server-tab-security" style="display:none">
            <div class="form-row">
                <label for="node-config-input-user"><i class="fa fa-user"></i> User</label>
                <input type="text" id="node-config-input-user" >
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
                <input type="password" id="node-config-input-password" >
            </div>
        </div>
    </div>
</script>
<script type="text/x-red" data-help-name="oracle-server">
    <h3>Connection</h3>
    <h4>Connection Name:</h4>
    <p>A name for this connection.</p>
    <h4>Connection Type:</h4>
    <ul>
        <li><b>Classic:</b> A connection using <span class="property-type">host</span>, <span class="property-type">port</span>, and <span class="property-type">db</span>.</li>
        <li><b>TNS Name:</b> A connection using a TNS Name which requires a wallet to be installed on the server.</li>
    </ul>
    <h5>Instant Client Path</h5>
    <p>The path on your server to the directory in which you installed the Oracle Instant Client. Ex: <code>/path/to/instantclient</code>.</p>

    <h4>When 'Classic' Connection Type Is Chosen:</h4>
    <ul>
        <li><b>Server:</b> The host name for the Oracle DB server.</li>
        <li><b>Port:</b> The server port.</li>
        <li><b>Database:</b> The DB name.</li>
    </ul>

    <h4>When 'TNS Name' Connection Type Is Chosen:</h4>
    <ul>
        <li><b>TNS Name:</b> The TNS Name. Requires that your wallet is placed in the <code>/path/to/instantclient/network/admin</code> directory on the server. Must match an entry in the <code>tnsnames.ora</code> file!</li>
    </ul>

    <h4>Optional:</h4>
    <ul>
        <li><b>Enable automatic connection</b></li>
        <li><b>Reconnect interval (ms)</b></li>
    </ul>

    <h3>Security</h3>
    <h4>Credentials</h4>
    <ul>
        <li><b>User:</b> The username to use to establish the connection.</li>
        <li><b>Password:</b> The DB user's password.</li>
    </ul>

    <p><b>Note:</b> You must install the Oracle Instant Client and place your Wallet contents in the <code>/path/to/instantclient/network/admin</code> directory on the server before using a TNS Name Connection.</p>
</script>
<!-- OracleDB ----------------------------------------------------------------->

<script type="text/x-red" data-template-name="oracledb">
    <div class="form-row">
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-input-oracle-out-tabs"></ul>
    </div>
    <div id="node-input-oracle-out-tabs-content" style="min-height: 170px;">
        <div id="oracle-out-tab-connection" style="display:none">
              <div class="form-row">
                  <label for="node-input-server"><i class="fa fa-globe"></i> Server</label>
                  <input type="text" id="node-input-server">
              </div>

              <br/>
              <div class="form-row">
                  <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
                  <input type="text" id="node-input-name" placeholder="Name">
              </div>
        </div>
        <div id="oracle-out-tab-query" style="display:none">
            <div class="form-row" style="margin-bottom: 0px">
                <input type="checkbox" id="node-input-usequery" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-usequery" style="width: 80%;">always execute this Oracle SQL statement (even if <i>msg.query</i> exists):</label>
            </div>

            <div class="form-row node-input-query-text-editor-row">
                <textarea id="node-input-query" style="display: none;"></textarea>
                <div style="height: 250px;" class="node-text-editor" id="node-input-query-editor" ></div>
            </div>
        </div>
        <div id="oracle-out-tab-mappings" style="display:none">
            <div class="form-row" style="margin-bottom: 0px">
                <input type="checkbox" id="node-input-usemappings" style="display: inline-block; width: auto; vertical-align: top;">
                <label for="node-input-usemappings" style="width: 80%;"> always use field mappings (even if <i>msg.payload</i> is an array)</label>
            </div>

            <div class="form-row node-input-mappings-text-editor-row">
                <textarea id="node-input-mappings" style="display: none;"></textarea>
                <div style="height: 250px;" class="node-text-editor" id="node-input-mappings-editor" ></div>
            </div>
        </div>
        <div id="oracle-out-tab-results" style="display:none">
            <div class="form-row">
                <label for="node-input-resultaction"><i class="fa fa-hand-o-right"></i> Action</label>
                <select type="text" id="node-input-resultaction" style="width: 270px;">
                    <option value="none">ignore query results</option>
                    <option value="single">send single query result message</option>
                    <option value="multi">send multiple query result messages</option>
                </select>
            </div>

            <div class="form-row">
                <label for="node-input-resultlimit"><i class="fa fa-bars"></i> Msg rows</label>
                <input type="text" id="node-input-resultlimit" style="width: 80px;"> (maximum # of result rows per message)
            </div>
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="oracledb">
  <p>Oracle database storage node. Connects to a server and inserts rows into the database or retrieves rows from the database with a SQL query.</p>
  <p>Expects an object called
  <b>msg</b> containing <b>msg.payload</b> and optionally <b>msg.query</b> and <b>msg.mappings</b>.</p>
  <p>
  <b>msg.payload</b>: array containing the fields to be used inside the query, first element in the array corresponds with the first `:fieldname` parameter in the query etc.<br>
  <b>msg.query</b>: string containing the SQL query, if this is not available, the default SQL query will be used.<br>
  <b>msg.fieldMappings</b>: array containing the object to array field mappings. Will be used if the content of <i>msg.payload</i> is not an array. If this is not available, the default field mappings will be used.<br>
  <b>msg.resultAction</b>: string containing "single", "multi" or "none", if "single" a single result message containing the resulting rows will be sent, if "multi" the results can be spread over multiple messages, if "none" no messages will be sent.
  If this is not available the default defined in <i>Query results</i> will be used.<br>
  <b>msg.resultSetSize</b>: number, maximum number of rows in a result message. If this is not available the default defined in <i>Query results</i> will be used.
  </p>
</script>

<script type="text/javascript">
//
// -- oracle server --------------------------------------------------------------------------------
//
RED.nodes.registerType("oracle-server", {
    category: "config",
    defaults: {
        connectionname: { value: "", required: true },
        tnsname: { value: "" },
        connectiontype: { value: "Classic" },
        instantclientpath: { value: "" },
        host: { value: "localhost", required: false },
        port: { value: 1521, required: false, validate: function (v) {
                return v == null || v.match(/^(\s*|\d+|null)$/);
            } },
        reconnect: { value: true },
        reconnecttimeout: { value: 5000, validate: RED.validators.number() },
        db: { value: "", required: false },
    },
    credentials: {
        user: { type: "text" },
        password: { type: "password" }
    },
    label: function () {
        return this.connectionname;
    },
    oneditprepare: function () {
        var tabs = RED.tabs.create({
            id: "node-config-oracle-server-tabs",
            onchange: function (tab) {
                $("#node-config-oracle-server-tabs-content").children().hide();
                $("#" + tab.id).show();
            }
        });
        $(".connection-type").hide();
        $("#node-config-input-connectiontype").on("change", function (evt) {
            if (evt.currentTarget.value === "TNS Name") {
                $("#wallet-container").show();
                $("#classic-container").hide();
                $("#node-config-input-host").val("");
                $("#node-config-input-port").val("");
                $("#node-config-input-db").val("");
            }
            else {
                $("#wallet-container").hide();
                $("#classic-container").show();
                $("#node-config-input-tnsname").val("");
            }
        });
        tabs.addTab({
            id: "oracle-server-tab-connection",
            label: "Connection"
        });
        tabs.addTab({
            id: "oracle-server-tab-security",
            label: "Security"
        });
        setTimeout(function () { tabs.resize(); }, 0);
        // function updateTLSOptions() {
        //     if ($("#node-config-input-usetls").is(":checked")) {
        //         $("#node-config-input-verifyservercert").prop("disabled", false);
        //         $("#node-config-input-verifyservercert").next().css("color", "");
        //     } else {
        //         $("#node-config-input-verifyservercert").prop("disabled", true);
        //         $("#node-config-input-verifyservercert").next().css("color", "#aaa");
        //     }
        // }
        // updateTLSOptions();
        // $("#node-config-input-usetls").on("click", function () {
        //     updateTLSOptions();
        // });
    }
});

//
// -- oracledb -------------------------------------------------------------------------------------
//
RED.nodes.registerType("oracledb", {
    category: "storage",
    defaults: {
        name: { value: "" },
        usequery: { value: false },
        query: { value: "INSERT INTO oracleTableName" +
                "\n\t(fieldName1, fieldName2, Fieldname3)" +
                "\n\tVALUES (" +
                "\n\t\t:valueOfValuesArrayIndex0," +
                "\n\t\t:valueOfValuesArrayIndex1," +
                "\n\t\t:valueOfValuesArrayIndex2," +
                "\n\t\)" },
        usemappings: { value: false },
        mappings: { value: "[" +
                "\n\t\"location.of.first.array.index.field.in.msg.payload\"," +
                "\n\t\"location.of.second.array.index.field\"," +
                "\n\t\"last_array_indexfield.in[3]\"" +
                "\n]" },
        server: { type: "oracle-server", required: true },
        resultaction: { value: "multi" },
        resultlimit: { value: 100 }
    },
    inputs: 1,
    outputs: 1,
    color: "#ff6666",
    icon: "db.png",
    align: "right",
    label: function () {
        return this.name || "oracledb";
    },
    labelStyle: function () {
        return this.name ? "node_label_italic" : "";
    },
    oneditprepare: function () {
        // use query editor
        var queryField = $("#node-input-query");
        var queryEditor = RED.editor.createEditor({
            id: "node-input-query-editor",
            mode: "ace/mode/sql",
            value: queryField.val()
        });
        queryEditor.getSession().on("change", function () {
            queryField.val(queryEditor.getSession().getValue());
        });
        // use mappings editor
        var mappingsField = $("#node-input-mappings");
        var mappingsEditor = RED.editor.createEditor({
            id: "node-input-mappings-editor",
            mode: "ace/mode/json",
            value: mappingsField.val()
        });
        mappingsEditor.getSession().on("change", function () {
            mappingsField.val(mappingsEditor.getSession().getValue());
        });
        var visibleTab = "query";
        var tabs = RED.tabs.create({
            id: "node-input-oracle-out-tabs",
            onchange: function (tab) {
                $("#node-input-oracle-out-tabs-content").children().hide();
                $("#" + tab.id).show();
                if (tab.id === "oracle-out-tab-query") {
                    visibleTab = "query";
                    functionDialogResize();
                    queryEditor.focus();
                }
                if (tab.id === "oracle-out-tab-mappings") {
                    visibleTab = "mappings";
                    functionDialogResize();
                    mappingsEditor.focus();
                }
            }
        });
        tabs.addTab({
            id: "oracle-out-tab-connection",
            label: "Server connection"
        });
        tabs.addTab({
            id: "oracle-out-tab-query",
            label: "SQL query"
        });
        tabs.addTab({
            id: "oracle-out-tab-mappings",
            label: "Field mappings"
        });
        tabs.addTab({
            id: "oracle-out-tab-results",
            label: "Query results"
        });
        setTimeout(function () { tabs.resize(); }, 0);
        // resize editor areas to fit the edit window
        function functionDialogResize() {
            var height = $("#dialog-form").height();
            height -= $("#node-input-oracle-out-tabs").outerHeight(true);
            var rows = $("#oracle-out-tab-" + visibleTab + ">div:not(.node-input-" + visibleTab + "-text-editor-row)");
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-" + visibleTab + "-text-editor-row");
            if (editorRow.css("marginTop")) {
                height -= parseInt(editorRow.css("marginTop"), 10);
            }
            if (editorRow.css("marginBottom")) {
                height -= parseInt(editorRow.css("marginBottom"), 10);
            }
            height -= 5;
            $("#node-input-" + visibleTab + "-editor").css("height", height + "px");
            if (visibleTab === "query") {
                queryEditor.resize();
            }
            else {
                mappingsEditor.resize();
            }
        }
        $("#dialog").on("dialogresize", functionDialogResize);
        $("#dialog").one("dialogopen", function (ev) {
            var size = $("#dialog").dialog("option", "sizeCache-function");
            if (size) {
                $("#dialog").dialog("option", "width", size.width);
                $("#dialog").dialog("option", "height", size.height);
                functionDialogResize();
            }
        });
        $("#dialog").one("dialogclose", function (ev, ui) {
            var height = $("#dialog").dialog("option", "height");
            $("#dialog").off("dialogresize", functionDialogResize);
        });
    }
});

</script>